name: ðŸšš deploy~

on:
  workflow_dispatch:
    inputs:
      dry_run:
        description: "dry run"
        type: boolean
        default: true
      release_mommy:
        description: "create mommy release"
        type: boolean
        default: true
      release_apt:
        description: "create apt-mommy release"
        type: boolean
        default: true
      release_aur:
        description: "create aur-mommy release"
        type: boolean
        default: true
      release_homebrew:
        description: "create homebrew-mommy release"
        type: boolean
        default: true

permissions:
  contents: write
  discussions: write
  packages: read

jobs:
  pre-flight-checks:
    if: "!(contains(github.event.head_commit.message, '[cd skip]') || contains(github.event.head_commit.message, '[skip cd]'))"
    runs-on: ubuntu-latest

    outputs:
      MOMMY_VERSION: ${{ steps.mommy_version.outputs.MOMMY_VERSION }}

    steps:
      - name: Print inputs
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run }}
          RELEASE_MOMMY: ${{ github.event.inputs.release_mommy }}
          RELEASE_APT: ${{ github.event.inputs.release_apt }}
          RELEASE_AUR: ${{ github.event.inputs.release_aur }}
          RELEASE_HOMEBREW: ${{ github.event.inputs.release_homebrew }}
        run: |
          printf "dry_run: '%s'\n" "$DRY_RUN"
          printf "release_mommy: '%s'\n" "$RELEASE_MOMMY"
          printf "release_apt: '%s'\n" "$RELEASE_APT"
          printf "release_aur: '%s'\n" "$RELEASE_AUR"
          printf "release_homebrew: '%s'\n" "$RELEASE_HOMEBREW"
      - name: Checkout
        uses: actions/checkout@v4
      - name: Extract and validate mommy's version number
        id: mommy_version
        run: |
          MOMMY_VERSION="v$(head -n 1 ./version)"
          test -n "$MOMMY_VERSION"
          expr match "$MOMMY_VERSION" "^v[0-9a-zA-Z\-\.]*$" >/dev/null

          printf "Found version '%s'\n" "$MOMMY_VERSION"
          printf "MOMMY_VERSION=%s\n" "$MOMMY_VERSION" >> "$GITHUB_ENV"
          printf "MOMMY_VERSION=%s\n" "$MOMMY_VERSION" >> "$GITHUB_OUTPUT"
      - name: "Check: Version is listed in changelog"
        # yes, you really do need to compare with a string, and no, using ! does not work~
        if: ${{ github.event.inputs.dry_run == 'false' }}
        run: grep -qF "# [${MOMMY_VERSION#v}] -- " CHANGELOG.md
      - name: "Check: Changelog does not contain string 'TODO'"
        if: ${{ github.event.inputs.dry_run == 'false' }}
        run: '! grep -qF TODO CHANGELOG.md'
      - name: "Check: Release does not already exist"
        if: ${{ github.event.inputs.dry_run == 'false' }}
        run: |
          # Using `fetch-tags` option of `actions/checkout` does not work properly
          git fetch --prune --unshallow --tags
          ! git show-ref --tags "$MOMMY_VERSION" --quiet


  build-linux:
    needs: [ pre-flight-checks ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install fpm and build dependencies
        run: |
          sudo apt install -y rubygems libarchive-tools rpm zstd
          sudo gem install --no-document fpm
      - name: Build packages
        run: make dist/generic dist/apk dist/deb dist/rpm dist/pacman
      - name: Upload built package
        uses: actions/upload-artifact@v4
        with:
          name: dist-linux
          path: dist/mommy*

  build-macos:
    needs: [ pre-flight-checks ]
    runs-on: macos-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install fpm
        run: sudo gem install --no-document fpm
      - name: Build package
        run: make dist/osxpkg
      - name: Upload built package
        uses: actions/upload-artifact@v4
        with:
          name: dist-macos
          path: dist/mommy*

  build-freebsd:
    needs: [ pre-flight-checks ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install fpm && Build package
        uses: cross-platform-actions/action@v0.30.0
        with:
          operating_system: freebsd
          version: "14.3"
          run: |
            printf "::group::Install basic packages\n"
            sudo pkg install -y git gmake
            printf "::endgroup::\n"

            # fpm
              printf "::group::Install fpm: Actually install fpm\n"
              sudo pkg install -y devel/ruby-gems
              sudo gem install --no-document fpm
              printf "::endgroup::\n"

              # TODO[Workaround]: Remove after https://github.com/jordansissel/fpm/pull/1922 is merged
              printf "::group::Install fpm: Install gtar\n"
              sudo pkg install -y gtar
              sudo mv /usr/bin/tar /usr/bin/bsdtar
              sudo mv /usr/local/bin/gtar /usr/bin/tar
              printf "::endgroup::\n"
            # /fpm

            printf "::group::Ignore ownership issues\n"
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
            printf "::endgroup::\n"

            printf "::group::Build package\n"
            gmake dist/freebsd
            printf "::endgroup::\n"
      - name: Upload built package
        uses: actions/upload-artifact@v4
        with:
          name: dist-freebsd
          path: dist/mommy*

  build-netbsd:
    needs: [ pre-flight-checks ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Build package
        uses: cross-platform-actions/action@v0.30.0
        with:
          operating_system: netbsd
          version: "10.1"
          run: |
            set -e
            export PATH="/usr/sbin:$PATH"  # Add 'pkg_*' commands to path

            printf "::group::Install basic packages\n"
            sudo pkgin -y in git gmake mozilla-rootcerts-openssl
            printf "::endgroup::\n"

            printf "::group::Ignore ownership issues\n"
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
            printf "::endgroup::\n"

            printf "::group::Build package\n"
            gmake dist/netbsd
            printf "::endgroup::\n"
      - name: Upload built package
        uses: actions/upload-artifact@v4
        with:
          name: dist-netbsd
          path: dist/mommy*

  build-openbsd:
    needs: [ pre-flight-checks ]
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Install fpm && Build package
        uses: cross-platform-actions/action@v0.30.0
        with:
          operating_system: openbsd
          version: "7.8"
          run: |
            printf "::group::Install basic packages\n"
            sudo pkg_add git gmake
            printf "::endgroup::\n"

            printf "::group::Install fpm\n"
            sudo pkg_add "$(pkg_info -Q ruby | grep "^ruby-[0-9]" | tail -n 1)"
            sudo /usr/local/bin/gem* install --no-document fpm
            sudo ln -s "$(printf "%s\n" /usr/local/bin/fpm* | tr " " \\n | grep -E "[0-9]+$")" /usr/local/bin/fpm  # Symlink 'fpm' to latest version
            printf "::endgroup::\n"

            printf "::group::Ignore ownership issues\n"
            git config --global --add safe.directory "$GITHUB_WORKSPACE"
            printf "::endgroup::\n"

            printf "::group::Build package\n"
            gmake dist/openbsd
            printf "::endgroup::\n"
      - name: Upload built package
        uses: actions/upload-artifact@v4
        with:
          name: dist-openbsd
          path: dist/mommy*


  release-mommy:
    if: ${{ github.event.inputs.release_mommy == 'true' }}
    # `pre-flight-checks` is required to access `MOMMY_VERSION`
    needs: [ pre-flight-checks, build-linux, build-macos, build-freebsd, build-netbsd, build-openbsd ]
    runs-on: ubuntu-latest
    env:
      MOMMY_VERSION: ${{ needs.pre-flight-checks.outputs.MOMMY_VERSION }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
      - name: Download built packages
        uses: actions/download-artifact@v4
        with:
          pattern: dist-*
          merge-multiple: true
          path: dist
      - name: Extract release notes
        run: |
          HEAD="$(printf "mommy can also be installed using a package manager. [check the readme for more info](https://github.com/fwdekker/mommy/tree/%s#-installation)~" "$MOMMY_VERSION")"
          BODY="$(awk "/^## \[${MOMMY_VERSION#v}\]/{flag=1;next}; /^## /{flag=0}; {if (flag==1) {print}}" CHANGELOG.md)"

          printf "%s\n\n%s\n" "$HEAD" "$BODY" | tee RELEASE_NOTES.md
      - name: Publish release
        if: ${{ github.event.inputs.dry_run == 'false' && github.event.inputs.release_mommy == 'true' }}
        env:
          GH_TOKEN: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
        run: |
          gh release create "$MOMMY_VERSION" \
            dist/mommy* \
            --title "$MOMMY_VERSION" \
            --notes-file RELEASE_NOTES.md \
            --target main \
            --discussion-category announcements

      - name: Checkout 'latest'
        uses: actions/checkout@v4
        with:
          ref: latest
          fetch-depth: 0
          fetch-tags: true
          # Required to push fast-forwarded branch back
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      - name: Update 'latest' branch
        if: ${{ github.event.inputs.dry_run == 'false' && github.event.inputs.release_mommy == 'true' }}
        run: |
          git merge --ff-only origin/main
          git push

  release-apt:
    if: ${{ github.event.inputs.release_apt == 'true' }}
    needs: [ pre-flight-checks, release-mommy ]
    runs-on: ubuntu-latest
    env:
      MOMMY_VERSION: ${{ needs.pre-flight-checks.outputs.MOMMY_VERSION }}

    steps:
      - name: Checkout mommy
        uses: actions/checkout@v4
        with:
          path: src-mommy
      - name: Checkout apt-mommy
        uses: actions/checkout@v4
        with:
          repository: fwdekker/apt-mommy
          path: apt-mommy
          ref: main
          fetch-depth: 0
          # Required to push '.deb' to repository
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      - name: Download built packages
        uses: actions/download-artifact@v4
        with:
          pattern: dist-*
          merge-multiple: true
          path: dist-mommy
      - name: Move .deb into apt-mommy
        run: cp dist-mommy/*.deb apt-mommy/deb/

      - name: Import GPG key
        env:
          APT_GPG_PRIVATE_KEY: ${{ secrets.APT_GPG_PRIVATE_KEY }}
        run: printf "%s\n" "$APT_GPG_PRIVATE_KEY" | gpg --import
      - name: Update apt-mommy
        working-directory: apt-mommy
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          printf "::group::Run update script\n"
          ./update.sh
          printf "::endgroup::\n"

          printf "::group::Commit changes\n"
          git config --global user.name fwdekkerbot
          git config --global user.email bot@fwdekker.com
          git add --all
          git commit -m "ðŸ”– mommy added package mommy $MOMMY_VERSION~"
          printf "::endgroup::\n"

          if [ "$DRY_RUN" = "false" ]; then
            printf "::group::Push changes\n"
            git push origin
            printf "::endgroup::\n"
          else
            printf "::group::Not pushing changes\n"
            printf "::endgroup::\n"
          fi;

  release-aur:
    if: ${{ github.event.inputs.release_aur == 'true' }}
    needs: [ pre-flight-checks, release-mommy ]
    runs-on: ubuntu-latest
    container: archlinux:latest
    env:
      MOMMY_VERSION: ${{ needs.pre-flight-checks.outputs.MOMMY_VERSION }}

    steps:
      - name: Set up basic system
        run: |
          printf "::group::Update system\n"
          pacman -Syu --noconfirm
          printf "::endgroup::\n"

          printf "::group::Install basic packages\n"
          pacman -S --noconfirm --needed git base-devel
          printf "::endgroup::\n"

          printf "::group::Add non-privileged user to run makepkg\n"
          useradd -m build
          printf "build ALL=(ALL:ALL) NOPASSWD: ALL\n" >> /etc/sudoers
          printf "::endgroup::\n"

      - name: Checkout mommy
        uses: actions/checkout@v4
        with:
          path: src-mommy

      - name: Checkout aur-mommy
        uses: actions/checkout@v4
        with:
          repository: fwdekker/aur-mommy
          path: aur-mommy
          ref: master
          fetch-depth: 0
          # Required to trigger CI action when pushed
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      - name: Fix aur-mommy directory ownership
        run: chown -R build:build ./aur-mommy/
      - name: Update build files
        working-directory: aur-mommy
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          if [ "$DRY_RUN" = "false" ]; then
            empty_option=""
          else
            empty_option="--allow-empty"
          fi;

          printf "::group::Fast-forward main\n"
          sudo -u build git checkout dev
          sudo -u build git checkout master
          sudo -u build git merge --commit dev
          printf "::endgroup::\n"

          printf "::group::Update build files\n"
          sudo -u build ./update.sh "$MOMMY_VERSION"
          printf "::endgroup::\n"

          printf "::group::Commit update\n"
          sudo -u build git config --global user.name fwdekkerbot
          sudo -u build git config --global user.email bot@fwdekker.com
          sudo -u build git add --all
          sudo -u build git commit -m "ðŸ”– mommy updated the build files to mommy $MOMMY_VERSION~" $empty_option
          printf "::endgroup::\n"

          printf "::group::Fast-forward dev\n"
          sudo -u build git checkout dev
          sudo -u build git merge --commit master
          printf "::endgroup::\n"

          if [ "$DRY_RUN" = "false" ]; then
            printf "::group::Push changes\n"
            sudo -u build git push origin master dev
            printf "::endgroup::\n"
          else
            printf "::group::Not pushing changes\n"
            printf "::endgroup::\n"
          fi;

  release-homebrew:
    if: ${{ github.event.inputs.release_homebrew == 'true' }}
    needs: [ pre-flight-checks, release-mommy ]
    runs-on: ubuntu-latest
    env:
      MOMMY_VERSION: ${{ needs.pre-flight-checks.outputs.MOMMY_VERSION }}

    steps:
      - name: Checkout mommy
        uses: actions/checkout@v4
        with:
          path: src-mommy
      - name: Checkout homebrew-mommy
        uses: actions/checkout@v4
        with:
          repository: fwdekker/homebrew-mommy
          path: homebrew-mommy
          ref: main
          fetch-depth: 0
          # Required to trigger CI action when pushed
          token: ${{ secrets.PERSONAL_ACCESS_TOKEN }}
      - name: Update formula
        working-directory: homebrew-mommy
        env:
          DRY_RUN: ${{ github.event.inputs.dry_run }}
        run: |
          if [ "$DRY_RUN" = "false" ]; then
            empty_option=""
          else
            empty_option="--allow-empty"
          fi;

          printf "::group::Fast-forward main\n"
          git checkout dev
          git checkout main
          git merge --commit dev
          printf "::endgroup::\n"

          printf "::group::Update formula\n"
          ./update.sh "$MOMMY_VERSION"
          printf "::endgroup::\n"

          printf "::group::Commit update\n"
          git config --global user.name fwdekkerbot
          git config --global user.email bot@fwdekker.com
          git add --all
          git commit -m "ðŸ”– mommy updated the formula to mommy $MOMMY_VERSION~" $empty_option
          printf "::endgroup::\n"

          printf "::group::Fast-forward dev\n"
          git checkout dev
          git merge --commit main
          printf "::endgroup::\n"

          if [ "$DRY_RUN" = "false" ]; then
            printf "::group::Push changes\n"
            git push origin main dev
            printf "::endgroup::\n"
          else
            printf "::group::Not pushing changes\n"
            printf "::endgroup::\n"
          fi;
